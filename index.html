<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Velvet Oracle — Rituel</title>

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- PAKO (inflate pour qs= compressé) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>

  <style>
    :root{
      --bg:#070708;
      --panel: rgba(18,18,20,.72);
      --panel2: rgba(12,12,14,.78);
      --gold:#c8a96a;
      --gold2:#e2c98a;
      --muted: rgba(255,255,255,.68);
      --muted2: rgba(255,255,255,.42);
      --line: rgba(200,169,106,.22);
      --ok: rgba(92, 255, 168, .18);
      --bad: rgba(255, 86, 86, .18);
    }

    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 50% 35%, rgba(200,169,106,.10), transparent 55%),
                  radial-gradient(900px 600px at 50% 75%, rgba(200,169,106,.06), transparent 60%),
                  var(--bg);
      color:#fff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }

    .wrap{
      width:min(520px, 100%);
      position:relative;
    }

    .build{
      position:absolute;
      top:-14px;
      left:0;
      padding:10px 14px;
      border-radius:999px;
      background: rgba(0,0,0,.55);
      border:1px solid var(--line);
      color: var(--gold2);
      font-weight:700;
      letter-spacing:.08em;
      font-size:12px;
      text-transform:uppercase;
      backdrop-filter: blur(10px);
    }

    .card{
      border-radius:22px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      overflow:hidden;
    }

    .top{
      padding:22px 22px 12px;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      opacity:.95;
    }
    .sigil{
      width:26px;height:26px;
      border-radius:50%;
      border:1px solid var(--line);
      display:grid;
      place-items:center;
      color:var(--gold2);
      font-weight:800;
      font-size:14px;
      background: rgba(200,169,106,.10);
      box-shadow: 0 0 30px rgba(200,169,106,.12);
    }
    .title{
      font-weight:800;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size:12px;
      color: var(--muted2);
    }

    .screen{
      padding:18px 22px 22px;
    }

    .hero{
      text-align:center;
      padding:8px 0 14px;
    }
    .hero h1{
      margin:10px 0 6px;
      font-size:18px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color: rgba(255,255,255,.88);
    }
    .hero p{
      margin:0;
      color: var(--muted2);
      font-size:13px;
      line-height:1.45;
    }

    .btnPrimary{
      width:100%;
      margin-top:16px;
      border:0;
      border-radius:999px;
      padding:16px 16px;
      font-weight:800;
      letter-spacing:.06em;
      text-transform:uppercase;
      background: linear-gradient(180deg, var(--gold2), var(--gold));
      color:#111;
      cursor:pointer;
      box-shadow: 0 16px 50px rgba(200,169,106,.22);
    }
    .btnPrimary:active{ transform: translateY(1px); }

    .quizHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      margin-bottom:10px;
    }
    .meta{
      font-size:12px;
      color: var(--muted2);
      letter-spacing:.03em;
      line-height:1.2;
    }
    .counter{
      font-size:12px;
      color: rgba(255,255,255,.72);
      letter-spacing:.06em;
    }

    .question{
      margin:10px 0 14px;
      font-size:16px;
      line-height:1.4;
      color: rgba(255,255,255,.92);
      padding:14px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.07);
      background: rgba(0,0,0,.25);
    }

    .options{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .option-btn{
      width:100%;
      text-align:left;
      border-radius:16px;
      padding:14px 14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.9);
      cursor:pointer;
      transition: transform .08s ease, border-color .2s ease, background .2s ease;
    }
    .option-btn:hover{ border-color: rgba(200,169,106,.35); }
    .option-btn:active{ transform: translateY(1px); }
    .option-btn.selected{
      border-color: rgba(200,169,106,.55);
      background: rgba(200,169,106,.10);
    }
    .option-btn.correct{
      border-color: rgba(92,255,168,.55);
      background: var(--ok);
    }
    .option-btn.wrong{
      border-color: rgba(255,86,86,.55);
      background: var(--bad);
    }
    .option-btn.disabled{
      cursor:not-allowed;
      opacity:.9;
    }

    .actions{
      display:flex;
      gap:10px;
      margin-top:14px;
    }
    .btnGhost{
      flex:1;
      border-radius:999px;
      padding:14px 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.86);
      font-weight:800;
      letter-spacing:.05em;
      text-transform:uppercase;
      cursor:pointer;
    }
    .btnGhost:disabled{
      opacity:.45;
      cursor:not-allowed;
    }

    .explain{
      margin-top:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.25);
      padding:12px 14px;
      color: rgba(255,255,255,.78);
      font-size:13px;
      line-height:1.45;
      display:none;
    }

    .footer{
      text-align:center;
      padding:14px 22px 18px;
      color: rgba(255,255,255,.28);
      font-size:12px;
      border-top:1px solid rgba(255,255,255,.06);
      letter-spacing:.04em;
    }

    /* Debug overlay (peut rester, discret) */
    #debug-url{
      position:fixed;
      top:10px; left:10px; right:10px;
      z-index:999999;
      font: 11px system-ui;
      background: rgba(0,0,0,.70);
      border:1px solid rgba(200,169,106,.22);
      border-radius:12px;
      padding:10px;
      color: rgba(255,255,255,.70);
      white-space: pre-wrap;
      opacity:.92;
      display:none; /* <-- passe à block si tu veux toujours voir */
    }
  </style>
</head>

<body>
  <div id="debug-url">URL: (loading…)</div>

  <div class="wrap">
    <div class="build" id="buildTag">BUILD TEST-777</div>

    <div class="card">
      <div class="top">
        <div class="brand">
          <div class="sigil">V</div>
          <div class="title">Velvet Oracle — Antichambre</div>
        </div>
      </div>

      <div class="screen" id="screenIntro">
        <div class="hero">
          <h1>Rituel d’entrée privé</h1>
          <p>Ce n’est pas un quiz. C’est un rituel silencieux.<br>Une seule fois. Aucun bruit. Juste toi.</p>
          <button class="btnPrimary" id="btnStart">Je suis prêt</button>
        </div>
      </div>

      <div class="screen" id="screenQuiz" style="display:none;">
        <div class="quizHeader">
          <div class="meta" id="quizMeta">Domaine : —</div>
          <div class="counter"><span id="quizIndex">1</span>/<span id="quizTotal">15</span></div>
        </div>

        <div class="question" id="quizQuestion">—</div>

        <div class="options" id="quiz-options"></div>

        <div class="explain" id="quizExplain"></div>

        <div class="actions">
          <button class="btnGhost" id="btnValidate" disabled>Valider la réponse</button>
          <button class="btnGhost" id="btnFinish" style="display:none;">Terminer le rituel</button>
        </div>
      </div>

      <div class="screen" id="screenDone" style="display:none;">
        <div class="hero">
          <h1>Rituel scellé</h1>
          <p id="doneText">Transmission en cours…</p>
          <button class="btnPrimary" id="btnClose">Fermer</button>
        </div>
      </div>

      <div class="footer">© Velvet Élite — Édition Oracle</div>
    </div>
  </div>

<script>
/* ============================================================
   VELVET ORACLE — index.html FULL WORKING
   - Lit ?qs= (pako inflate + JSON)
   - Fallback si qs absent
   - Rend 4 options (A/B/C/D) TOUJOURS
   - Envoie résultat au bot via Telegram.WebApp.sendData
   ============================================================ */

(function(){
  // ---------- Telegram init ----------
  const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
  try { tg && tg.ready(); } catch(e){}

  // ---------- Helpers ----------
  const _safeStr = (v) => (v === null || v === undefined) ? "" : String(v);
  const shuffleArray = (arr) => {
    const a = arr.slice();
    for (let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  };

  function _pick(obj, keys){
    for (const k of keys){
      if (obj && Object.prototype.hasOwnProperty.call(obj,k) && obj[k] !== undefined && obj[k] !== null) return obj[k];
    }
    return undefined;
  }

  function normalizeOptions(raw){
    // raw peut être:
    // - Array ["a","b","c","d"]
    // - Object {A:"",B:"",C:"",D:""} ou {"0":"",...}
    if (Array.isArray(raw) && raw.length >= 4) {
      const clean = raw.slice(0,4).map(v => _safeStr(v).trim());
      if (clean.filter(v=>v.length>0).length===4) return clean;
    }
    if (raw && typeof raw === "object") {
      const keys = Object.keys(raw);
      // 0..3
      if (keys.includes("0") && keys.includes("1") && keys.includes("2") && keys.includes("3")){
        const arr = [raw["0"],raw["1"],raw["2"],raw["3"]].map(v=>_safeStr(v).trim());
        if (arr.filter(v=>v.length>0).length===4) return arr;
      }
      // A..D
      if (keys.includes("A") && keys.includes("B") && keys.includes("C") && keys.includes("D")){
        const arr = [raw["A"],raw["B"],raw["C"],raw["D"]].map(v=>_safeStr(v).trim());
        if (arr.filter(v=>v.length>0).length===4) return arr;
      }
    }
    // fallback ultime
    return ["—","—","—","—"];
  }

  function mapQuestion(src){
    const id = _safeStr(_pick(src, ["id","ID_question","ID","record_id","airtable_id"])) || ("Q" + Math.random().toString(16).slice(2));
    const domain = _safeStr(_pick(src, ["domain","Domaine","domaine"])) || "—";
    const level = Number(_pick(src, ["level","Niveau","niveau"])) || 0;
    const question = _safeStr(_pick(src, ["question","Question","libelle","texte"])) || "—";
    const optionsRaw = _pick(src, ["options","Options","propositions","choices","answers"]);
    const options = normalizeOptions(optionsRaw);
    const correct_index = Number(_pick(src, ["correct_index","Correct_index","correct","answerIndex"])) || 0;
    const explanation = _safeStr(_pick(src, ["explanation","Explanation","explication"])) || "";

    if (options.join("") === "————") {
      console.warn("[Velvet] OPTIONS VIDES après normalisation:", { id, domain, level, srcKeys:Object.keys(src||{}) });
    }

    return { id, domain, level, question, options, correct_index, explanation };
  }

  function tryLoadQsetFromQs(){
    const qs = new URLSearchParams(location.search).get("qs");
    if (!qs) return null;

    // qs est une string base64url d'un zlib deflate (pako inflate) => JSON string
    try{
      // base64url -> base64
      const b64 = qs.replace(/-/g, "+").replace(/_/g, "/");
      const pad = b64.length % 4 ? "=".repeat(4 - (b64.length % 4)) : "";
      const bin = atob(b64 + pad);

      const bytes = new Uint8Array(bin.length);
      for (let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);

      const inflated = pako.inflate(bytes);
      const jsonStr = new TextDecoder("utf-8").decode(inflated);
      const obj = JSON.parse(jsonStr);

      // obj attendu: {v:1, source:"airtable", total:15, questions:[...]}
      return obj;
    } catch(e){
      console.error("[Velvet] QS decode failed:", e);
      return null;
    }
  }

  // ---------- Fallback minimal (si qs absent / cassé) ----------
  const FALLBACK_QUIZ_DATA = [
    {
      id:"FALLBACK_1",
      domain:"Musique",
      level:4,
      question:"Dans l’effervescence baroque italienne, quel maître fixe vraiment la grammaire du concerto moderne ?",
      options:["Arcangelo Corelli","Antonio Vivaldi","Giuseppe Torelli","Tomaso Albinoni"],
      correct_index:0,
      explanation:"Corelli structure et stabilise le concerto grosso et l’écriture orchestrale naissante. Vivaldi popularisera plus tard une forme plus brillante, mais la charpente vient d’abord de Corelli."
    },
    {
      id:"FALLBACK_2",
      domain:"Arts",
      level:3,
      question:"Quel effet recherche principalement le clair-obscur en peinture ?",
      options:["Créer un contraste dramatique lumière/ombre","Uniformiser les volumes","Supprimer la profondeur","Remplacer la couleur par le dessin"],
      correct_index:0,
      explanation:"Le clair-obscur met la lumière en scène pour dramatiser, guider l’œil et modeler les volumes. Il organise la hiérarchie visuelle et la tension narrative."
    },
    {
      id:"FALLBACK_3",
      domain:"Géographie",
      level:1,
      question:"Quelle ville est surnommée la “Cidade Invicta” ?",
      options:["Porto","Lisbonne","Braga","Coimbra"],
      correct_index:0,
      explanation:"Porto porte ce surnom lié à sa résistance historique. Une marque identitaire discrète, mais tenace."
    },
    {
      id:"FALLBACK_4",
      domain:"Sciences",
      level:2,
      question:"Quel matériau constitue la base du verre le plus courant ?",
      options:["Sable (silice)","Calcaire","Argile","Sel"],
      correct_index:0,
      explanation:"La silice est la base du verre. On l’associe à d’autres composants pour abaisser la température de fusion et stabiliser la structure."
    }
  ];

  // ---------- Source finale ----------
  const LIVE_QSET = tryLoadQsetFromQs();
  const QUIZ_DATA = (LIVE_QSET && Array.isArray(LIVE_QSET.questions) && LIVE_QSET.questions.length)
    ? LIVE_QSET.questions.map(mapQuestion)
    : FALLBACK_QUIZ_DATA;

  // Debug global (ce que tu cherchais)
  window.__VO_DEBUG = { LIVE_QSET, QUIZ_DATA };

  // ---------- Debug URL overlay ----------
  const debugEl = document.getElementById("debug-url");
  const qsPresent = !!new URLSearchParams(location.search).get("qs");
  debugEl.textContent =
    "URL:\n" + location.href + "\n\n" +
    "qs present: " + qsPresent + "\n" +
    "qs length: " + (qsPresent ? new URLSearchParams(location.search).get("qs").length : 0);

  // ---------- UI refs ----------
  const screenIntro = document.getElementById("screenIntro");
  const screenQuiz  = document.getElementById("screenQuiz");
  const screenDone  = document.getElementById("screenDone");

  const btnStart    = document.getElementById("btnStart");
  const btnValidate = document.getElementById("btnValidate");
  const btnFinish   = document.getElementById("btnFinish");
  const btnClose    = document.getElementById("btnClose");

  const quizMetaEl     = document.getElementById("quizMeta");
  const quizIndexEl    = document.getElementById("quizIndex");
  const quizTotalEl    = document.getElementById("quizTotal");
  const quizQuestionEl = document.getElementById("quizQuestion");
  const optionsWrap    = document.getElementById("quiz-options");
  const explainEl      = document.getElementById("quizExplain");
  const doneText       = document.getElementById("doneText");

  // ---------- State ----------
  const LETTERS = ["A","B","C","D"];
  const TOTAL_QUESTIONS = QUIZ_DATA.length;
  let currentIndex = 0;
  let currentShuffle = [0,1,2,3];
  let selectedDisplayIndex = null;
  let answers = [];
  let correctCount = 0;

  quizTotalEl.textContent = String(TOTAL_QUESTIONS);

  function setScreens(which){
    screenIntro.style.display = (which==="intro") ? "block" : "none";
    screenQuiz.style.display  = (which==="quiz")  ? "block" : "none";
    screenDone.style.display  = (which==="done")  ? "block" : "none";
  }

  function renderQuestion(){
    const q = QUIZ_DATA[currentIndex];
    console.log("[Velvet] Q0=", QUIZ_DATA[0], "RAW_Q0=", LIVE_QSET && LIVE_QSET.questions ? LIVE_QSET.questions[0] : null);
    console.log("[Velvet] renderQuestion", q);

    quizMetaEl.textContent = `Domaine : ${q.domain || "—"}`;
    quizIndexEl.textContent = String(currentIndex + 1);
    quizQuestionEl.textContent = q.question || "—";

    // reset
    explainEl.style.display = "none";
    explainEl.textContent = "";
    selectedDisplayIndex = null;
    btnValidate.disabled = true;
    btnFinish.style.display = "none";

    // build options
    optionsWrap.innerHTML = "";
    currentShuffle = shuffleArray([0,1,2,3]);

    currentShuffle.forEach((realIndex, displayIndex) => {
      const btn = document.createElement("button");
      btn.className = "option-btn";
      btn.textContent = `${LETTERS[displayIndex]}. ${q.options[realIndex] ?? "—"}`;
      btn.addEventListener("click", () => selectAnswer(displayIndex));
      optionsWrap.appendChild(btn);
    });

    console.log("OPTIONS =", q.options);
  }

  function getButtons(){
    return Array.from(optionsWrap.querySelectorAll(".option-btn"));
  }

  function selectAnswer(displayIndex){
    selectedDisplayIndex = displayIndex;
    btnValidate.disabled = false;
    const buttons = getButtons();
    buttons.forEach((b, i) => {
      b.classList.toggle("selected", i === displayIndex);
    });
  }

  function validateAnswer(){
    const q = QUIZ_DATA[currentIndex];
    const buttons = getButtons();

    // mapping display -> real
    const chosenRealIndex = currentShuffle[selectedDisplayIndex];
    const correctRealIndex = q.correct_index;

    const isCorrect = (chosenRealIndex === correctRealIndex);
    if (isCorrect) correctCount++;

    // lock buttons
    buttons.forEach((b, displayIndex) => {
      b.classList.add("disabled");
      b.disabled = true;

      const realIndex = currentShuffle[displayIndex];
      if (realIndex === correctRealIndex) b.classList.add("correct");
      if (displayIndex === selectedDisplayIndex && !isCorrect) b.classList.add("wrong");
    });

    // store answer
    answers.push({
      id: q.id,
      domain: q.domain,
      level: q.level,
      question: q.question,
      options: q.options,
      correct_index: q.correct_index,
      chosen_display_index: selectedDisplayIndex,
      chosen_real_index: chosenRealIndex,
      is_correct: isCorrect
    });

    // show explanation
    if (q.explanation && q.explanation.trim().length){
      explainEl.textContent = q.explanation.trim();
      explainEl.style.display = "block";
    }

    // next step
    const last = (currentIndex === TOTAL_QUESTIONS - 1);
    if (last){
      btnFinish.style.display = "block";
      btnValidate.style.display = "none";
    } else {
      btnValidate.textContent = "Question suivante";
      btnValidate.disabled = false;
      btnValidate.onclick = nextQuestion;
    }
  }

  function nextQuestion(){
    // restore validate button behavior
    btnValidate.textContent = "Valider la réponse";
    btnValidate.onclick = validateAnswer;

    currentIndex++;
    if (currentIndex >= TOTAL_QUESTIONS){
      finishRitual();
      return;
    }
    renderQuestion();
  }

  function finishRitual(){
    setScreens("done");

    const payload = {
      v: 1,
      source: (LIVE_QSET && LIVE_QSET.source) ? LIVE_QSET.source : "fallback",
      total: TOTAL_QUESTIONS,
      correct: correctCount,
      answers: answers,
      ts: Date.now()
    };

    // send to bot (Telegram WebApp)
    try {
      if (tg && typeof tg.sendData === "function") {
        tg.sendData(JSON.stringify(payload));
        doneText.textContent = "Transmission scellée. Tu peux fermer.";
      } else {
        doneText.textContent = "Mode navigateur : Telegram WebApp non détecté. (Données non envoyées)";
        console.warn("[Velvet] Telegram WebApp not available. Payload:", payload);
      }
    } catch(e){
      doneText.textContent = "Erreur d’envoi. (Voir console)";
      console.error("[Velvet] sendData failed:", e);
    }
  }

  // ---------- Buttons wiring ----------
  btnStart.addEventListener("click", () => {
    setScreens("quiz");
    renderQuestion();
  });

  btnValidate.onclick = validateAnswer;

  btnFinish.addEventListener("click", finishRitual);

  btnClose.addEventListener("click", () => {
    try { tg && tg.close(); } catch(e){}
    // fallback close
    window.close();
  });

  // ---------- Auto-open in Telegram if possible ----------
  // (on ne force pas : c'est juste propre)
  try { tg && tg.expand(); } catch(e){}

})();
</script>

</body>
</html>
