<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Velvet Oracle ‚Äî Rituel</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- ‚úÖ PAKO (zlib inflate) pour lire ?qs= -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>

  <style>
    /* ===========================
       FONTS ‚Äî MORENA (√Ä LA RACINE)
    ============================ */
    @font-face { font-family: "Morena"; src: url("Morena-ExtraLight.otf") format("opentype"); font-weight: 200; font-style: normal; font-display: swap; }
    @font-face { font-family: "Morena"; src: url("Morena-Light.otf") format("opentype"); font-weight: 300; font-style: normal; font-display: swap; }
    @font-face { font-family: "Morena"; src: url("Morena.otf") format("opentype"); font-weight: 400; font-style: normal; font-display: swap; }
    @font-face { font-family: "Morena"; src: url("Morena-Semibold.otf") format("opentype"); font-weight: 600; font-style: normal; font-display: swap; }
    @font-face { font-family: "Morena"; src: url("Morena-Bold.otf") format("opentype"); font-weight: 700; font-style: normal; font-display: swap; }

    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root{
      --velvet-black:#050505;
      --card-bg:#101010;
      --velvet-gold:#c8a96a;
      --velvet-gold-soft:#e4c98c;
      --amber-soft:#d9b677;
      --text-main:#f5f2e8;
      --text-muted:rgba(245,242,232,.72);
      --danger:#ff4b4b;
      --success:#27ae60;
      --card-border:rgba(200,169,106,.45);
      --option-bg:#151515;
      --option-border:rgba(255,255,255,.05);

      --font-body:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,-webkit-system-font,"Segoe UI",Roboto,sans-serif;
      --font-display:"Morena",-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,-webkit-system-font,"Segoe UI",Roboto,sans-serif;

      --neutral-glow: rgba(200,169,106,0.22);
      --neutral-glow-2: rgba(245,242,232,0.10);
      --good-glow: rgba(39,174,96,0.35);
      --bad-glow: rgba(255,75,75,0.28);
      --gold-glow: rgba(200,169,106,0.48);
      --gold-glow-soft: rgba(228,201,140,0.20);
    }

    body{
      background: radial-gradient(circle at top, #181818 0, #050505 52%, #000 100%);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px 14px;
      font-family:var(--font-display);
      color:var(--text-main);
    }

    button, input, textarea, select{
      font-family: var(--font-display);
      -webkit-font-smoothing: antialiased;
      text-rendering: geometricPrecision;
    }

    .frame{ width:100%; max-width:480px; animation: fadeIn .6s ease-out; }
    .hidden{ display:none !important; }

    .logo{ display:flex; justify-content:center; align-items:center; margin-bottom:18px; }
    .logo img{ max-width:180px; opacity:.97; filter: drop-shadow(0 4px 14px rgba(0,0,0,.7)); }

    /* ===== ANTICHAMBRE ===== */
    .badge{
      font-size:11px; letter-spacing:.35em; text-transform:uppercase;
      color:var(--text-muted); opacity:.7; margin-bottom:18px; text-align:center;
      font-weight:600;
    }

    .card{
      width:100%;
      background: linear-gradient(145deg, #0a0a0a, #121212);
      border-radius:20px;
      border:1px solid var(--card-border);
      box-shadow: 0 24px 60px rgba(0,0,0,.9), 0 0 0 1px rgba(255,255,255,.02);
      padding:26px 22px 24px;
      overflow:hidden;
      text-align:center;
    }

    .title{
      font-weight:600;
      font-size:26px;
      letter-spacing:.08em;
      text-transform:uppercase;
      margin-bottom:6px;
    }

    .subtitle{
      font-weight:300;
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:.24em;
      color:var(--text-muted);
      margin-bottom:18px;
    }

    .divider{
      width:40px; height:1px;
      background: linear-gradient(90deg, transparent, rgba(200,169,106,.9), transparent);
      margin: 0 auto 18px auto;
    }

    .body-text{ font-size:15px; line-height:1.75; color:var(--text-muted); margin-bottom:20px; font-weight:600; }
    .body-text span{ color:var(--velvet-gold-soft); }
    .footer-text{ font-size:13px; line-height:1.7; color:rgba(245,242,232,.7); margin-bottom:20px; font-weight:600; }
    .note{ font-size:11px; text-align:center; letter-spacing:.18em; text-transform:uppercase; color:rgba(245,242,232,.55); margin-bottom:10px; font-weight:600; }

    .cta{
      width:100%;
      border-radius:999px;
      border:none;
      padding:14px 18px;
      font-size:15px;
      font-weight:700;
      letter-spacing:.14em;
      text-transform:uppercase;
      background: linear-gradient(135deg, var(--velvet-gold), var(--velvet-gold-soft));
      color:#000;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      box-shadow: 0 18px 40px rgba(0,0,0,.9), 0 0 0 1px rgba(0,0,0,.6);
      transition: transform .16s ease-out, box-shadow .16s ease-out, filter .16s ease-out;
      font-family: var(--font-display);
    }
    .cta:active{ transform: translateY(1px); filter: brightness(.96); box-shadow: 0 10px 26px rgba(0,0,0,.9), 0 0 0 1px rgba(0,0,0,.7); }

    .under-card{ margin-top:14px; font-size:11px; text-align:center; color:rgba(245,242,232,.45); font-weight:600; }

    /* ===== CHAMBRE ===== */
    .chamber{
      width:100%;
      background: radial-gradient(circle at top, #0b0b0b 0, #020202 60%, #000 100%);
      border-radius:22px;
      border:1px solid rgba(200,169,106,.35);
      box-shadow: 0 26px 70px rgba(0,0,0,.95), 0 0 0 1px rgba(255,255,255,.02);
      padding:26px 22px 26px;
      text-align:center;
    }

    .chamber-heading{
      font-size:11px; letter-spacing:.28em; text-transform:uppercase;
      color:rgba(245,242,232,.6); margin-bottom:14px;
      font-weight:600;
    }
    .chamber-title{
      font-weight:600;
      font-size:20px;
      text-transform:uppercase;
      letter-spacing:.16em;
      color:var(--velvet-gold-soft);
      margin-bottom:12px;
    }
    .chamber-line{
      width:56px; height:1px;
      background: linear-gradient(90deg, rgba(200,169,106,0), rgba(200,169,106,.9), rgba(200,169,106,0));
      margin: 0 auto 18px auto;
    }
    .chamber-text{
      font-size:15px; line-height:1.75; color:rgba(245,242,232,.78); margin-bottom:26px;
      font-weight:600;
    }
    .chamber-text span{ color:var(--velvet-gold-soft); }
    .chamber-cta{
      width:100%;
      border-radius:999px;
      border:1px solid rgba(200,169,106,.4);
      padding:13px 18px;
      background:#111;
      color:var(--velvet-gold-soft);
      letter-spacing:.16em;
      text-transform:uppercase;
      font-size:13px;
      cursor:pointer;
      font-weight:700;
      font-family: var(--font-display);
    }

    /* ===== QUIZ ===== */
    .quiz-card{
      width:100%;
      background: radial-gradient(circle at top, #151515 0, #050505 55%, #000 100%);
      border-radius:24px;
      border:1px solid rgba(200,169,106,.38);
      box-shadow: 0 30px 80px rgba(0,0,0,.96), 0 0 0 1px rgba(255,255,255,.02);
      padding:22px 18px 18px;
      display:flex;
      flex-direction:column;
      gap:18px;
      position:relative;
      overflow:hidden;
    }
    .quiz-card::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity:0.18;
      background:
        radial-gradient(circle at 20% 10%, rgba(255,255,255,0.06), transparent 40%),
        radial-gradient(circle at 80% 30%, rgba(200,169,106,0.05), transparent 45%),
        radial-gradient(circle at 50% 90%, rgba(255,255,255,0.04), transparent 55%);
      mix-blend-mode: screen;
      z-index:1;
    }

    .quiz-card.signature{
      border-color: rgba(200,169,106,0.60);
      box-shadow:
        0 30px 80px rgba(0,0,0,0.96),
        0 0 0 1px rgba(255,255,255,0.02),
        0 0 34px var(--gold-glow),
        0 0 70px var(--gold-glow-soft);
      animation: signatureBreath 2.8s ease-in-out infinite;
    }
    @keyframes signatureBreath{ 0%,100%{ filter: brightness(1);} 50%{ filter: brightness(1.06);} }

    /* ===== Anneau horloger (Signature) ===== */
    .quiz-card.signature::after{
      content:"";
      position:absolute;
      inset:12px;
      border-radius:20px;
      pointer-events:none;
      z-index:4;
      background:
        conic-gradient(
          from 0deg,
          rgba(200,169,106,0.00) 0deg,
          rgba(200,169,106,0.00) 300deg,
          rgba(200,169,106,0.18) 330deg,
          rgba(200,169,106,0.00) 360deg
        );
      -webkit-mask: radial-gradient(farthest-side, transparent calc(100% - 3px), #000 calc(100% - 2px));
      mask: radial-gradient(farthest-side, transparent calc(100% - 3px), #000 calc(100% - 2px));
      animation: velvetClockRing 110s linear infinite;
      opacity:0.95;
    }
    .quiz-card.signature .clock-ring-stroke{
      position:absolute;
      inset:14px;
      border-radius:18px;
      border:1px solid rgba(200,169,106,0.42);
      box-shadow:
        0 0 10px rgba(200,169,106,0.12),
        0 0 28px rgba(200,169,106,0.08);
      pointer-events:none;
      z-index:3;
      display:none;
    }
    @keyframes velvetClockRing{ to { transform: rotate(360deg); } }
    @media (prefers-reduced-motion: reduce){ .quiz-card.signature::after{ animation:none; } }

    /* ===== Patine argentique ‚Äî vignettage subtil (overlay d√©di√©) ===== */
    .quiz-vignette{
      position:absolute;
      inset:0;
      pointer-events:none;
      border-radius:24px;
      background:
        radial-gradient(
          circle at center,
          rgba(0,0,0,0) 58%,
          rgba(0,0,0,0.18) 72%,
          rgba(0,0,0,0.38) 100%
        );
      opacity:0.55;
      mix-blend-mode: multiply;
      z-index:2;
    }

    .quiz-header,
    .quiz-main,
    .quiz-options,
    .quiz-footer,
    .quiz-actions{
      position:relative;
      z-index:5;
    }

    .quiz-footer.vertical{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      margin-top:12px;
    }

    .quiz-footer .centered{
      text-align:center;
    }

    .quiz-timer{
      font-size:12px;
      letter-spacing:.22em;
      text-transform:uppercase;
      font-weight:700;
      color:rgba(245,242,232,.7);
    }

    .quiz-step{
      font-size:12px;
      letter-spacing:.2em;
      text-transform:uppercase;
      font-weight:700;
      color:rgba(245,242,232,.58);
    }

    .quiz-header{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:4px; }
    .quiz-logo-small img{ width:110px; opacity:.9; }

    .quiz-progress{
      padding:7px 12px;
      border-radius:999px;
      border:1px solid rgba(200,169,106,.45);
      font-size:11px;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:rgba(245,242,232,.85);
      white-space:nowrap;
      font-weight:700;
    }
    .quiz-progress span{ color:var(--velvet-gold-soft); }

    .quiz-main{ padding:10px 4px 2px; }
    .quiz-label{ font-size:12px; letter-spacing:.26em; text-transform:uppercase; color:rgba(245,242,232,.6); margin-bottom:10px; font-weight:700; }
    .quiz-question{ font-size:19px; line-height:1.8; color:var(--text-main); font-weight:600; }

    /* ===== Barre de temps ultra-fine ===== */
    .time-rail{
      margin-top:12px;
      height:2px;
      border-radius:999px;
      background: rgba(200,169,106,0.10);
      overflow:hidden;
      position:relative;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
    }
    .time-rail .time-fill{
      height:100%;
      width:100%;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(200,169,106,0.20), rgba(228,201,140,0.62), rgba(200,169,106,0.20));
      transform-origin: left center;
      transform: scaleX(1);
      opacity:0.92;
      transition: transform 0.18s linear;
      filter: drop-shadow(0 0 8px rgba(200,169,106,0.18));
    }
    .time-rail.lecture .time-fill{
      opacity:0.75;
      filter: drop-shadow(0 0 6px rgba(200,169,106,0.12));
    }
    .quiz-card.signature .time-rail{ background: rgba(200,169,106,0.14); }

    .quiz-meta{ font-size:12px; letter-spacing:.22em; text-transform:uppercase; color:rgba(245,242,232,.5); margin-top:14px; font-weight:700; }

    /* ‚úÖ Explications en font syst√®me */
    .quiz-explanation{
      margin-top:16px;
      padding:14px 14px 12px;
      border-radius:18px;
      background: linear-gradient(180deg, #111, #070707);
      border:1px solid rgba(200,169,106,.22);
      box-shadow: 0 16px 40px rgba(0,0,0,.85), 0 0 0 1px rgba(0,0,0,.6);
      font-size:14px;
      line-height:1.7;
      color:rgba(228,201,140,.92);
      font-style: italic;
      animation: exIn .28s ease-out;
      font-family: var(--font-body);
      font-weight: 400;
      letter-spacing: 0.01em;
    }
    @keyframes exIn{ from{opacity:0; transform: translateY(6px);} to{opacity:1; transform: translateY(0);} }

    .quiz-explanation-line{ margin-bottom:4px; }
    .ex-label{ text-transform:uppercase; letter-spacing:.16em; font-size:10px; color:rgba(245,242,232,.55); display:block; margin-bottom:4px; font-style:normal; }
    .ex-user span.letter{ color:var(--velvet-gold-soft); font-weight:600; }
    .ex-user span.text{ color:#f5f2e8; }
    .ex-correct span.letter{ color:#f2da9b; font-weight:600; }
    .ex-correct span.text{ color:rgba(228,201,140,.96); }
    .ex-orion{ margin-top:8px; color:var(--amber-soft); }
    .ex-result{ margin-top:6px; font-style:normal; font-size:11px; text-transform:uppercase; letter-spacing:.18em; }
    .ex-result.good{ color:#27ae60; } .ex-result.bad{ color:#c0392b; } .ex-result.timeout{ color:#e67e22; }

    .quiz-options{ margin-top:12px; display:flex; flex-direction:column; gap:12px; }

    /* ===== Reveal (voile + lame de lumi√®re) ===== */
    .quiz-options.veil .quiz-option{
      opacity:0.22;
      filter: saturate(0.85) brightness(0.88) blur(0.4px);
      transform: translateZ(0) scale(0.996);
    }
    .quiz-option .light-sweep{
      position:absolute;
      top:-25%;
      left:-70%;
      width:70%;
      height:150%;
      transform: skewX(-18deg);
      background: linear-gradient(
        90deg,
        rgba(255,255,255,0.00),
        rgba(228,201,140,0.22),
        rgba(245,242,232,0.28),
        rgba(228,201,140,0.22),
        rgba(255,255,255,0.00)
      );
      mix-blend-mode: screen;
      opacity:0.95;
      pointer-events:none;
      animation: sweep 0.75s ease-out forwards;
    }
    @keyframes sweep{ to { left: 130%; opacity:0; } }

    /* ===== Options ===== */
    .quiz-option{
      display:flex; align-items:center; gap:10px;
      width:100%;
      padding:18px 18px;
      background:var(--option-bg);
      border-radius:999px;
      border:1px solid var(--option-border);
      color:rgba(245,242,232,.94);
      font-size:17px;
      cursor:pointer;
      transition: background .16s ease-out, transform .12s ease-out, border-color .16s ease-out, box-shadow .16s ease-out, opacity .16s ease-out;
      position:relative;
      overflow:hidden;
      transform: translateZ(0);
      font-weight:400;
      font-family: var(--font-body);
    }
    .quiz-option:hover{
      border-color: rgba(200,169,106,0.22);
      box-shadow: 0 10px 24px rgba(0,0,0,0.65), 0 0 0 1px rgba(255,255,255,0.03);
      transform: translateY(-1px);
    }
    .quiz-option:active{ transform: translateY(1px); }
    .quiz-option-letter{
      width:34px; height:34px; border-radius:999px;
      border:2px solid rgba(200,169,106,.75);
      display:flex; align-items:center; justify-content:center;
      font-size:15px; color:var(--velvet-gold-soft);
      flex-shrink:0;
      font-weight:600;
      font-family: var(--font-body);
    }
    .quiz-option-text{ flex:1; text-align:left; font-size:16px; line-height:1.5; }

    .quiz-option.selected{
      background: radial-gradient(circle at top, #22160b 0, #15100a 60%, #060606 100%);
      border-color: rgba(200,169,106,0.95);
      box-shadow: 0 0 0 1px rgba(200,169,106,0.5);
      animation: selectBreath 1.05s ease-in-out infinite;
    }
    @keyframes selectBreath{ 0%,100%{ filter:brightness(1);} 50%{ filter:brightness(1.08);} }

    .quiz-option.disabled{ opacity:.6; cursor:default; pointer-events:none; }

    .quiz-option.correct{
      opacity:1 !important;
      border-color: rgba(39,174,96,0.70);
      box-shadow: 0 0 0 1px rgba(39,174,96,0.45), 0 0 24px var(--good-glow);
      background: radial-gradient(circle at top, rgba(39,174,96,0.20) 0, #141414 55%, #060606 100%);
    }
    .quiz-option.wrong{
      opacity:1 !important;
      border-color: rgba(255,75,75,0.55);
      box-shadow: 0 0 0 1px rgba(255,75,75,0.35), 0 0 18px var(--bad-glow);
      background: radial-gradient(circle at top, rgba(255,75,75,0.14) 0, #141414 55%, #060606 100%);
    }
    .quiz-option.timeout{ border-color: rgba(230,126,34,0.55); box-shadow: 0 0 0 1px rgba(230,126,34,0.30); }

    @keyframes velvetShake{ 0%{transform:translateX(0);} 25%{transform:translateX(-2px);} 50%{transform:translateX(2px);} 75%{transform:translateX(-1px);} 100%{transform:translateX(0);} }
    .quiz-option.wrong.shake{ animation: velvetShake .16s ease-in-out 1; }

    .quiz-option .ripple{
      position:absolute;
      border-radius:50%;
      transform:scale(0);
      opacity:.55;
      background: radial-gradient(circle, rgba(228,201,140,0.55), rgba(200,169,106,0.15), transparent 70%);
      pointer-events:none;
      animation: ripple .55s ease-out forwards;
    }
    @keyframes ripple{ to{ transform:scale(3.2); opacity:0; } }

    /* ===== Orf√®vrerie : filet dor√© au survol (desktop only) ===== */
    @media (hover:hover) and (pointer:fine){
      .quiz-option::after{
        content:"";
        position:absolute;
        inset:0;
        border-radius:999px;
        pointer-events:none;
        opacity:0;
        transition: opacity .18s ease-out;
        box-shadow:
          inset 0 0 0 1px rgba(200,169,106,0.28),
          inset 0 0 0 2px rgba(200,169,106,0.10);
      }
      .quiz-option:hover::after{ opacity:1; }
    }

    .quiz-footer{ display:flex; justify-content:space-between; align-items:center; margin-top:10px; font-size:12px; color:rgba(245,242,232,.58); }
    .quiz-timer,.quiz-step{ letter-spacing:.2em; text-transform:uppercase; font-weight:700; }
    .quiz-timer.pulse{ animation: timerPulse .9s ease-in-out infinite; }
    @keyframes timerPulse{ 0%,100%{opacity:.78;} 50%{opacity:1;} }

    .quiz-actions{ margin-top:12px; display:flex; justify-content:flex-end; }
    .quiz-next{
      border-radius:999px;
      border:none;
      padding:10px 18px;
      background: linear-gradient(135deg, var(--velvet-gold), var(--velvet-gold-soft));
      color:#000;
      font-size:13px;
      letter-spacing:.16em;
      text-transform:uppercase;
      font-weight:800;
      cursor:pointer;
      box-shadow: 0 14px 30px rgba(0,0,0,.9), 0 0 0 1px rgba(0,0,0,.7);
      opacity:.85;
      transition: opacity .15s ease-out, transform .12s ease-out;
      font-family: var(--font-display);
    }
    .quiz-next:disabled{ opacity:.35; box-shadow:none; cursor:default; }
    .quiz-next:not(:disabled):active{ transform: translateY(1px); }

    /* ===== RESULT / FEEDBACK ===== */
    .result-card,.feedback-final-card{
      width:100%;
      background: radial-gradient(circle at top, #141414 0, #050505 55%, #000 100%);
      border-radius:22px;
      border:1px solid rgba(200,169,106,.35);
      box-shadow: 0 26px 70px rgba(0,0,0,.95), 0 0 0 1px rgba(255,255,255,.02);
      padding:26px 22px 24px;
      text-align:center;
    }
    .result-heading{
      font-size:11px; letter-spacing:.26em; text-transform:uppercase;
      color:rgba(245,242,232,.65); margin-bottom:10px;
      font-weight:700;
    }
    .result-title{
      font-weight:600;
      font-size:20px;
      text-transform:uppercase;
      letter-spacing:.16em;
      color:var(--velvet-gold-soft);
      margin-bottom:10px;
    }
    .result-line{
      width:52px; height:1px;
      background: linear-gradient(90deg, rgba(200,169,106,0), rgba(200,169,106,.9), rgba(200,169,106,0));
      margin: 0 auto 16px auto;
    }
    .result-score{
      font-size:16px;
      letter-spacing:.22em;
      text-transform:uppercase;
      color:rgba(245,242,232,.8);
      margin-bottom:8px;
      font-weight:800;
    }
    .result-score span{ color:var(--velvet-gold-soft); }
    .result-meta{
      font-size:13px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color:rgba(245,242,232,.6);
      margin-bottom:16px;
      font-weight:700;
    }
    .result-subtitle{ font-size:14px; line-height:1.8; color:rgba(245,242,232,.78); margin-bottom:18px; font-weight:700; }
    .result-note{ font-size:12px; line-height:1.7; color:rgba(245,242,232,.6); margin-bottom:20px; font-weight:700; }

    .result-cta{
      width:100%;
      border-radius:999px;
      border:none;
      padding:13px 18px;
      background: linear-gradient(135deg, var(--velvet-gold), var(--velvet-gold-soft));
      color:#000;
      font-size:13px;
      letter-spacing:.16em;
      text-transform:uppercase;
      font-weight:800;
      cursor:pointer;
      box-shadow: 0 16px 36px rgba(0,0,0,.9), 0 0 0 1px rgba(0,0,0,.7);
      font-family: var(--font-display);
    }

    .feedback-title{
      font-weight:600;
      font-size:14px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:rgba(245,242,232,.82);
      margin-bottom:8px;
    }
    .feedback-helper{ font-size:13px; line-height:1.7; color:rgba(245,242,232,.6); margin-bottom:12px; font-weight:700; }
    .feedback-helper span{ color:var(--velvet-gold-soft); }
    .feedback-textarea{
      width:100%;
      min-height:96px;
      border-radius:14px;
      border:1px solid rgba(200,169,106,.55);
      background:#0d0d0d;
      padding:10px 12px;
      font-size:13px;
      line-height:1.5;
      color:var(--text-main);
      resize:vertical;
      outline:none;
      font-family: var(--font-display);
      font-weight:700;
    }
    .feedback-textarea::placeholder{ color:rgba(245,242,232,.55); }

    .feedback-send{
      margin-top:10px;
      width:100%;
      border-radius:999px;
      border:none;
      padding:11px 16px;
      background: linear-gradient(135deg, var(--velvet-gold), var(--velvet-gold-soft));
      color:#000;
      font-size:12px;
      letter-spacing:.16em;
      text-transform:uppercase;
      font-weight:800;
      cursor:pointer;
      box-shadow: 0 12px 28px rgba(0,0,0,.9), 0 0 0 1px rgba(0,0,0,.7);
      font-family: var(--font-display);
    }
    .feedback-send:disabled{ opacity:.45; cursor:default; box-shadow:none; }

    .feedback-final-message{ margin-top:16px; font-size:14px; line-height:1.8; color:rgba(245,242,232,.8); font-weight:700; }
    .feedback-final-signature{ margin-top:10px; font-size:11px; text-transform:uppercase; letter-spacing:.18em; color:rgba(245,242,232,.6); font-weight:700; }

    @keyframes fadeIn{ from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
    @media (min-width:520px){
      .card,.chamber,.quiz-card,.result-card,.feedback-final-card{ padding:26px 24px 26px; }
    }
  </style>
</head>

<body>
  <div class="frame">

    <!-- √âCRAN 1 -->
    <div class="screen-intro">
      <div class="badge">Velvet Oracle ‚Äî Antichambre</div>

      <div class="card">
        <div class="logo">
          <img src="velvet-logo.svg" alt="Velvet √âlite ‚Äî Velvet Oracle">
        </div>

        <div class="title">Velvet Oracle</div>
        <div class="subtitle">Rituel d‚Äôentr√©e priv√©</div>

        <div class="divider"></div>

        <p class="body-text">
          Ce n‚Äôest pas un quiz.
          C‚Äôest un <span>rituel silencieux</span>.
        </p>

        <p class="footer-text">
          Une seule fois. Aucun bruit.
          Juste toi, ton calme int√©rieur.
        </p>

        <p class="note">Quand tu te sentiras pr√™t</p>

        <button class="cta" id="btn-ready">Je suis pr√™t ‚óè</button>
      </div>

      <div class="under-card">¬© Velvet √âlite ‚Äî Edition Oracle.</div>
    </div>

    <!-- √âCRAN 2 -->
    <div class="screen-chamber hidden">
      <div class="chamber">
        <div class="logo">
          <img src="velvet-logo.svg" alt="Velvet √âlite ‚Äî Logo">
        </div>

        <div class="chamber-heading">Velvet Oracle ‚Äî Chambre</div>
        <div class="chamber-title">Silence int√©rieur</div>
        <div class="chamber-line"></div>

        <p class="chamber-text">
          Ici, rien ne se joue sur la chance.
          Chaque r√©ponse r√©v√®le ce que tu ma√Ætrises vraiment.
          <br><br>
          Quand tu continues, le <span>temps commence √† courir</span>.
        </p>

        <button class="chamber-cta" id="btn-start-ritual">‚óè Commencer le rituel</button>
      </div>
    </div>

    <!-- √âCRAN 3 -->
    <div class="screen-quiz hidden">
      <div class="quiz-card">
        <div class="quiz-vignette" aria-hidden="true"></div>
        <div class="clock-ring-stroke" aria-hidden="true"></div>

        <div class="quiz-header">
          <div class="quiz-logo-small">
            <img src="velvet-logo.svg" alt="Velvet Oracle">
          </div>
          <div class="quiz-progress">
            Q <span id="quiz-index">1</span> / <span id="quiz-total">15</span>
          </div>
        </div>

        <div class="quiz-main">
          <div class="quiz-label" id="quiz-label">Rituel ‚Äî S√©rie d‚Äôentr√©e</div>
          <div class="quiz-question" id="quiz-question"></div>

          <!-- Barre de temps (silencieuse) -->
          <div class="time-rail" id="time-rail" aria-hidden="true">
            <div class="time-fill" id="time-fill"></div>
          </div>

          <div class="quiz-meta" id="quiz-meta"></div>
          <div class="quiz-explanation hidden" id="quiz-explanation"></div>
        </div>

        <div class="quiz-options" id="quiz-options">
          <button class="quiz-option" data-display-index="0">
            <div class="quiz-option-letter">A</div>
            <div class="quiz-option-text"></div>
          </button>
          <button class="quiz-option" data-display-index="1">
            <div class="quiz-option-letter">B</div>
            <div class="quiz-option-text"></div>
          </button>
          <button class="quiz-option" data-display-index="2">
            <div class="quiz-option-letter">C</div>
            <div class="quiz-option-text"></div>
          </button>
          <button class="quiz-option" data-display-index="3">
            <div class="quiz-option-letter">D</div>
            <div class="quiz-option-text"></div>
          </button>
        </div>

        <div class="quiz-footer vertical">
          <div class="quiz-timer centered" id="quiz-timer">Temps ¬∑ 00:20</div>
          <div class="quiz-step centered">
            ‚úÖ Bonnes r√©ponses :
            <span id="quiz-correct-count">0</span>
            /
            <span id="quiz-current-index">1</span>
          </div>
        </div>

        <div class="quiz-actions">
          <button class="quiz-next" id="btn-next" disabled>Valider la r√©ponse</button>
        </div>
      </div>
    </div>

    <!-- √âCRAN 4 -->
    <div class="screen-result hidden">
      <div class="result-card">
        <div class="logo">
          <img src="velvet-logo.svg" alt="Velvet Oracle ‚Äî R√©sultats">
        </div>

        <div class="result-heading">Velvet Oracle ‚Äî Rituel</div>
        <div class="result-title" id="result-title">Verdict du rituel</div>
        <div class="result-line"></div>

        <div class="result-score">
          Score ¬∑ <span id="result-score">0 / 15</span>
        </div>
        <div class="result-meta">
          Temps total ¬∑ <span id="result-time">00:00</span>
        </div>

        <div class="result-subtitle" id="result-subtitle">
          Ce rituel est une photographie de ce soir.
          <span>La suite se joue dans la dur√©e.</span>
        </div>

        <div class="result-note">
          Ce passage ne te d√©finit pas.
          Il indique simplement jusqu‚Äôo√π ta culture tient sous pression, ici et maintenant.
        </div>

        <button class="result-cta" id="btn-go-feedback">
          Confier ton ressenti & valider ta participation
        </button>
      </div>
    </div>

    <!-- √âCRAN 5 -->
    <div class="screen-feedback-final hidden">
      <div class="feedback-final-card">
        <div class="logo">
          <img src="velvet-logo.svg" alt="Velvet Oracle ‚Äî Feedback">
        </div>

        <div class="result-heading">Velvet Oracle ‚Äî Trace silencieuse</div>
        <div class="result-line" style="margin-bottom:14px;"></div>

        <div class="feedback-title">Laisser une trace pour ton futur toi</div>
        <div class="feedback-helper">
          Quelques lignes suffisent.
          <span>√âcris comme si tu te relisais dans quelques ann√©es.</span>
        </div>

        <textarea
          id="feedback-final-text"
          class="feedback-textarea"
          rows="4"
          placeholder="Note ce qui t‚Äôa sembl√© fluide, ce qui t‚Äôa r√©sist√©, ce que ce rituel a r√©veill√© en toi : assurance, doute, agacement, envie de hausser ton niveau."
        ></textarea>

        <button class="feedback-send" id="btn-feedback-final-send">Envoyer ton ressenti</button>
        <button class="feedback-send hidden" id="btn-feedback-close">Vous pouvez fermer cette fen√™tre</button>

        <div class="feedback-final-message hidden" id="feedback-final-message"></div>
        <div class="feedback-final-signature hidden" id="feedback-final-signature">Velvet √âlite ¬∑ Velvet Oracle</div>
      </div>
    </div>

  </div>

  <!-- Micro-son feutr√© (fichier √† fournir) -->
  <audio id="velvet-tick" preload="auto">
    <source src="tick-soft.mp3" type="audio/mpeg">
  </audio>

  <script>
    // =====================================================
    // ‚úÖ Velvet Oracle ‚Äî Live Questions via ?qs= (zlib+base64url)
    // =====================================================
    function _b64urlToUint8Array(b64url) {
      let b64 = (b64url || "").replace(/-/g, "+").replace(/_/g, "/");
      while (b64.length % 4) b64 += "=";
      const binary = atob(b64);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
      return bytes;
    }

    function _tryLoadQsetFromQs() {
      const qs = new URLSearchParams(window.location.search).get("qs");
      if (!qs) return null;

      try {
        if (!window.pako) {
          console.warn("[Velvet] pako manquant ‚Äî impossible de d√©compresser qs.");
          return null;
        }

        const compressed = _b64urlToUint8Array(qs);
        const inflated = window.pako.inflate(compressed);
        const jsonStr = new TextDecoder("utf-8").decode(inflated);

        const qset = JSON.parse(jsonStr);
        if (!qset || !Array.isArray(qset.questions) || qset.questions.length !== 15) {
          console.warn("[Velvet] qs pr√©sent mais qset invalide:", qset);
          return null;
        }

        console.log("[Velvet] Live qset charg√©:", qset.source, "total=", qset.total);
        return qset;
      } catch (e) {
        console.warn("[Velvet] √âchec lecture qs:", e);
        return null;
      }
    }

    // =====================================================
    // ‚úÖ FALLBACK (tes questions en dur)
    // =====================================================
    const FALLBACK_QUIZ_DATA = [
      { id: 1, domain: "Musique", level: 4, question: "Dans l‚Äôeffervescence baroque italienne, quel ma√Ætre fixe vraiment la grammaire du concerto moderne ?", options: ["Arcangelo Corelli","Antonio Vivaldi","Giuseppe Torelli","Tomaso Albinoni"], correct_index: 1, explication: `Vivaldi ne fait pas qu‚Äô√©crire une multitude de concertos : il en fixe la grammaire.
La forme en trois mouvements (rapide‚Äìlent‚Äìrapide), le dialogue structur√© entre soliste et orchestre
et la virtuosit√© assum√©e deviennent, avec lui, un langage stable que Bach lui-m√™me √©tudiera et transposera.
Corelli ou Torelli pr√©parent le terrain, mais c‚Äôest Vivaldi qui impose vraiment le standard du concerto moderne.` },
      { id: 2, domain: "Musique", level: 4, question: "Dans l‚Äôunivers lusophone, quel chant m√™le saudade, douleur retenue et m√©lodie modale ?", options: ["Morna","Flamenco","Fado","Kizomba"], correct_index: 2, explication: `Le fado na√Æt dans les quartiers populaires de Lisbonne et cristallise la saudade portugaise :
une nostalgie profonde, teint√©e de manque et de fatalisme √©l√©gant. La morna cap-verdienne porte aussi
une m√©lancolie, mais dans un autre contexte culturel ; le flamenco est plus br√ªlant et percussif,
la kizomba plus dansante. C‚Äôest le fado qui incarne le mieux cette douleur retenue, soutenue par des lignes
m√©lodiques souvent modales.` },
      { id: 3, domain: "Musique", level: 5, question: "Quelle figure russe transforme l‚Äôoppression d‚Äôun peuple en une Cinqui√®me symphonie d‚Äôune √¢pret√© saisissante ?", options: ["Sergue√Ø Rachmaninov","Dmitri Chostakovitch","Sergue√Ø Prokofiev","Piotr Ilitch Tcha√Økovski"], correct_index: 1, explication: `La Cinqui√®me symphonie de Chostakovitch (1937) est √©crite sous le regard pesant du r√©gime stalinien,
apr√®s une mise au ban officielle. En surface, l‚Äô≈ìuvre semble r√©pondre aux exigences du r√©alisme socialiste ;
en profondeur, elle laisse filtrer une tension, une ironie tragique et une √¢pret√© qui ont souvent √©t√© lues
comme le reflet de l‚Äôoppression subie par tout un peuple.` },
      { id: 4, domain: "Science", level: 4, question: "En physique moderne, quelle constante fixe la vitesse ultime permise √† toute information ?", options: ["La constante de Planck","La vitesse de la lumi√®re","La constante gravitationnelle","La charge √©l√©mentaire"], correct_index: 1, explication: `Dans la relativit√© restreinte d‚ÄôEinstein, la vitesse de la lumi√®re dans le vide, not√©e c, d√©finit la limite absolue
de propagation de l‚Äôinformation.` },
      { id: 5, domain: "Science", level: 4, question: "Quel savant du XVII·µâ si√®cle √©tablit la m√©canique fondatrice qui gouverne le mouvement ?", options: ["Galil√©e","Isaac Newton","Johannes Kepler","Ren√© Descartes"], correct_index: 1, explication: `Newton formalise la m√©canique classique avec ses trois lois du mouvement et la gravitation universelle.` },
      { id: 6, domain: "Science", level: 5, question: "Parmi les particules du monde ordinaire, laquelle porte la charge n√©gative qui structure la mati√®re ?", options: ["Le neutrino","Le muon","L‚Äô√©lectron","Le quark down"], correct_index: 2, explication: `Dans les atomes ordinaires, ce sont les √©lectrons qui portent la charge n√©gative et organisent la chimie.` },
      { id: 7, domain: "Civilisations/Mythologies", level: 4, question: "Dans le panth√©on √©gyptien, quelle divinit√© au visage de faucon incarne la lumi√®re victorieuse ?", options: ["R√™","Horus","Sobek","Seth"], correct_index: 1, explication: `Horus, t√™te de faucon, symbolise la royaut√© l√©gitime et la lumi√®re victorieuse.` },
      { id: 8, domain: "Civilisations/Mythologies", level: 4, question: "Quel peuple marchand d√©veloppe un alphabet consonantique qui influencera directement l‚Äôalphabet grec ?", options: ["Les Ph√©niciens","Les Assyriens","Les Hittites","Les Aram√©ens"], correct_index: 0, explication: `Les Ph√©niciens diffusent un alphabet consonantique repris et adapt√© par les Grecs.` },
      { id: 9, domain: "Civilisations/Mythologies", level: 5, question: "Dans les r√©cits anciens, quel roi errant √©l√®ve la ruse au rang d‚Äôart souverain pour d√©fier son destin ?", options: ["Jason","Th√©s√©e","Ulysse","√ân√©e"], correct_index: 2, explication: `Ulysse fait de l‚Äôintelligence tactique un art central (Odyss√©e, cheval de Troie, d√©guisements).` },
      { id: 10, domain: "Psychologie", level: 4, question: "Quel biais pousse l‚Äôesprit √† ne retenir que ce qui renforce ses convictions pr√©alables ?", options: ["Le biais de confirmation","Le biais de disponibilit√©","Le biais d‚Äôancrage","L‚Äôeffet de halo"], correct_index: 0, explication: `Le biais de confirmation favorise les informations qui confortent une croyance d√©j√† install√©e.` },
      { id: 11, domain: "Psychologie", level: 4, question: "Dans la pyramide de Maslow, quel besoin s‚Äôimpose juste apr√®s les n√©cessit√©s vitales ?", options: ["Les besoins sociaux","Les besoins de s√©curit√©","Les besoins d‚Äôestime","Les besoins d‚Äôaccomplissement"], correct_index: 1, explication: `Apr√®s le physiologique vient la s√©curit√© : stabilit√©, protection, pr√©visibilit√©.` },
      { id: 12, domain: "Psychologie", level: 5, question: "Quel m√©canisme d√©crit l‚Äôinconfort n√© de deux v√©rit√©s incompatibles que l‚Äôon tente malgr√© tout de r√©concilier ?", options: ["La r√©actance","La dissonance cognitive","La sublimation","La rationalisation"], correct_index: 1, explication: `La dissonance cognitive : tension interne quand croyances et actes se contredisent.` },
      { id: 13, domain: "Technologie", level: 4, question: "Quel pionnier de l‚Äôinformatique conceptualise la machine universelle ?", options: ["Ada Lovelace","Alan Turing","Claude Shannon","John von Neumann"], correct_index: 1, explication: `Turing formalise la machine universelle : simuler tout calcul formel.` },
      { id: 14, domain: "Technologie", level: 4, question: "Quel protocole assure la discr√©tion des √©changes web gr√¢ce √† une couche de chiffrement d√©di√©e ?", options: ["HTTP","TLS","HTTPS","SSL"], correct_index: 2, explication: `HTTPS = HTTP + couche chiffr√©e (TLS).` },
      { id: 15, domain: "Technologie", level: 5, question: "Quel mod√®le d‚Äôapprentissage s‚Äôaffine en superposant des couches successives de repr√©sentation ?", options: ["Un r√©seau convolutionnel (CNN)","Un r√©seau r√©current (RNN)","Un r√©seau profond (Deep Learning)","Un r√©seau g√©n√©ratif (GAN)"], correct_index: 2, explication: `Le deep learning renvoie √† la profondeur des couches et √† l‚Äôabstraction progressive.` }
    ];

    // =====================================================
    // ‚úÖ OUTILS ‚Äî extraction robuste options + explication
    // =====================================================
    const LETTERS = ["A","B","C","D"];

    function coerceText(x){
      if (x === null || x === undefined) return "";
      if (typeof x === "string") return x;
      if (typeof x === "number" || typeof x === "boolean") return String(x);
      if (typeof x === "object"){
        for (const k of ["text","label","value","name","title"]){
          if (Object.prototype.hasOwnProperty.call(x, k)) return coerceText(x[k]);
        }
      }
      return "";
    }

    // üî• Extrait les 4 premiers textes trouv√©s dans un objet/array imbriqu√©
    function extractFirst4StringsDeep(any){
      const out = [];
      const seen = new Set();

      function walk(v){
        if (out.length >= 4) return;
        if (v === null || v === undefined) return;

        if (typeof v === "string"){
          const s = v.trim();
          if (s && !seen.has(s)){
            seen.add(s);
            out.push(s);
          }
          return;
        }

        if (Array.isArray(v)){
          for (const x of v) walk(x);
          return;
        }

        if (typeof v === "object"){
          for (const k of Object.keys(v)) walk(v[k]);
        }
      }

      walk(any);
      while (out.length < 4) out.push("‚Äî");
      return out.slice(0,4);
    }

    // ‚úÖ Normalise options vers [a,b,c,d] quel que soit le format
    function normalizeOptions(raw){
      // string JSON ?
      if (typeof raw === "string"){
        const s = raw.trim();
        if ((s.startsWith("[") && s.endsWith("]")) || (s.startsWith("{") && s.endsWith("}"))){
          try { raw = JSON.parse(s); } catch(e){}
        }
      }

      // D√©j√† un tableau de 4
      if (Array.isArray(raw) && raw.length === 4){
        return raw.map(coerceText).map(s => s.trim());
      }

      // Objet lettre A/B/C/D
      if (raw && typeof raw === "object" && !Array.isArray(raw)){
        const keys = Object.keys(raw);
        const upper = keys.map(k => String(k).toUpperCase());
        const hasLetters = ["A","B","C","D"].every(L => upper.includes(L));
        if (hasLetters){
          const arr = ["A","B","C","D"].map(L => {
            const k = keys.find(x => String(x).toUpperCase() === L);
            return coerceText(raw[k]).trim();
          });
          if (arr.every(t => t.length > 0)) return arr;
        }
      }

      // Fallback ultime (impossible √† rater)
      return extractFirst4StringsDeep(raw);
    }

    function pickFirstNonEmpty(obj, keys){
      for (const k of keys){
        if (!obj) continue;
        if (Object.prototype.hasOwnProperty.call(obj, k)){
          const v = obj[k];
          if (v !== null && v !== undefined && String(v).trim().length > 0) return v;
        }
      }
      return "";
    }

    function normalizeExplanation(q){
      // Champ officiel chez toi: Explication
      const v =
        pickFirstNonEmpty(q, ["Explication","explication","Explanation","explanation"]) ||
        "";
      return coerceText(v).trim();
    }

    function normalizeDomain(q){
      return coerceText(pickFirstNonEmpty(q, ["Domaine","domaine","domain","Domain"]) || q.domain || "").trim();
    }

    function normalizeQuestionText(q){
      return coerceText(pickFirstNonEmpty(q, ["Question","question","Q","title"]) || q.question || "").trim();
    }

    function normalizeLevel(q){
      const v = pickFirstNonEmpty(q, ["Niveau","niveau","level","Level"]);
      const n = Number(v);
      return Number.isFinite(n) ? n : (Number(q.level) || 0);
    }

    function normalizeId(q, fallback){
      const v = pickFirstNonEmpty(q, ["ID_question","id_question","id","ID","Id"]);
      const n = Number(v);
      return Number.isFinite(n) ? n : (q.id ?? fallback);
    }

    function normalizeCorrectIndex(q){
      const v = pickFirstNonEmpty(q, ["Correct_index","correct_index","CorrectIndex","correctIndex"]);
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }

    // =====================================================
    // ‚úÖ SOURCE FINALE : Live via qs, sinon fallback
    // =====================================================
    const LIVE_QSET = _tryLoadQsetFromQs();

    const QUIZ_DATA = LIVE_QSET
      ? (LIVE_QSET.questions || []).map((q, i) => {
          // IMPORTANT : options peut venir sous plusieurs formes
          const optionsRaw =
            q.options ??
            q.Options ??
            q["Options (JSON)"] ??
            q.options_json ??
            (q.fields ? (q.fields.options ?? q.fields.Options ?? q.fields["Options (JSON)"]) : undefined) ??
            q.OPTIONS;

          const normOptions = normalizeOptions(optionsRaw);
          return {
            id: normalizeId(q, i+1),
            domain: normalizeDomain(q),
            level: normalizeLevel(q),
            question: normalizeQuestionText(q),
            options: normOptions,
            correct_index: normalizeCorrectIndex(q),
            explication: normalizeExplanation(q),
            _optionsType: (optionsRaw === null || optionsRaw === undefined) ? String(optionsRaw) : (Array.isArray(optionsRaw) ? "array" : typeof optionsRaw),
            _optionsKeys: (optionsRaw && typeof optionsRaw === "object" && !Array.isArray(optionsRaw)) ? Object.keys(optionsRaw).slice(0,10).join(",") : ""
          };
        })
      : FALLBACK_QUIZ_DATA.map(q => ({
          ...q,
          explication: q.explication || q.explanation || "",
          _optionsType: Array.isArray(q.options) ? "array" : typeof q.options,
          _optionsKeys: ""
        }));

    const TOTAL_QUESTIONS = QUIZ_DATA.length;

    const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
    if (tg && typeof tg.ready === "function") tg.ready();

    let currentIndex = 0;
    let currentSelection = null;
    let currentShuffle = [];
    let answers = [];
    let pendingAnswer = null;
    let showingExplanation = false;

    let ritualStartTime = null;
    let totalTimer = null;
    let lastTotalSeconds = 0;

    let questionTimer = null;
    let questionRemaining = 20;

    let explanationCountdown = null;
    let explanationRemaining = 60;

    let finalScore = 0;
    let finalEnrichedAnswers = [];
    let finalTotalSeconds = 0;
    let ritualFinished = false;
    let finalPayload = null;

    // ‚úÖ Compteur ‚Äúbonnes r√©ponses‚Äù live
    let correctCount = 0;

    // ===== Time Rail =====
    let railTotalSeconds = 20;

    // ===== Tick (haptique + micro-son) =====
    let tickPrimed = false;
    function primeTickAudio(){
      if (tickPrimed) return;
      tickPrimed = true;
      const a = document.getElementById("velvet-tick");
      if (!a) return;
      a.volume = 0.01;
      const p = a.play();
      if (p && typeof p.then === "function"){
        p.then(() => { a.pause(); a.currentTime = 0; a.volume = 0.22; })
         .catch(() => { a.volume = 0.22; });
      } else {
        a.pause(); a.currentTime = 0; a.volume = 0.22;
      }
    }

    function velvetTick(){
      if (tg && tg.HapticFeedback && typeof tg.HapticFeedback.impactOccurred === "function"){
        tg.HapticFeedback.impactOccurred("light");
      }
      const a = document.getElementById("velvet-tick");
      if (a){
        a.currentTime = 0;
        a.volume = 0.22;
        a.play().catch(()=>{});
      }
    }

    function formatSeconds(sec){
      const s = Math.max(0, sec);
      const m = Math.floor(s/60);
      const r = s % 60;
      return `${String(m).padStart(2,"0")}:${String(r).padStart(2,"0")}`;
    }

    function shuffleArray(arr){
      for (let i = arr.length-1; i>0; i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]] = [arr[j],arr[i]];
      }
      return arr;
    }

    function isSignatureIndex(idx0){ return idx0 === 2 || idx0 === 7 || idx0 === 12; }

    function setSignatureUI(active){
      const card = document.querySelector(".quiz-card");
      if (!card) return;
      card.classList.toggle("signature", !!active);

      const stroke = document.querySelector(".clock-ring-stroke");
      if (stroke) stroke.style.display = active ? "block" : "none";
    }

    function setTimerMode(mode){
      const el = document.getElementById("quiz-timer");
      if (!el) return;
      el.classList.toggle("pulse", mode === "lecture");
    }

    function setRailMode(mode){
      const rail = document.getElementById("time-rail");
      if (!rail) return;
      rail.classList.toggle("lecture", mode === "lecture");
    }

    function setRailProgress(remaining, total){
      const fill = document.getElementById("time-fill");
      if (!fill) return;
      const t = Math.max(1, total || 1);
      const r = Math.max(0, Math.min(remaining, t));
      fill.style.transform = `scaleX(${r / t})`;
    }

    function spawnRipple(btn, event){
      if (!btn) return;
      const rect = btn.getBoundingClientRect();
      const x = (event?.clientX ?? (rect.left + rect.width/2)) - rect.left;
      const y = (event?.clientY ?? (rect.top + rect.height/2)) - rect.top;
      const ripple = document.createElement("span");
      ripple.className = "ripple";
      const size = Math.max(rect.width, rect.height);
      ripple.style.width = ripple.style.height = `${size}px`;
      ripple.style.left = `${x - size/2}px`;
      ripple.style.top  = `${y - size/2}px`;
      btn.appendChild(ripple);
      ripple.addEventListener("animationend", () => ripple.remove());
    }

    function performVerdictReveal(correctDisplayIndex, applyStates){
      const wrap = document.getElementById("quiz-options");
      if (wrap) wrap.classList.add("veil");

      const correctBtn = optionButtons[correctDisplayIndex];
      if (correctBtn){
        const sweep = document.createElement("span");
        sweep.className = "light-sweep";
        correctBtn.appendChild(sweep);
        sweep.addEventListener("animationend", () => sweep.remove());
      }

      if (isSignatureIndex(currentIndex)) velvetTick();

      setTimeout(() => {
        if (wrap) wrap.classList.remove("veil");
        applyStates();
      }, 750);
    }

    const screenIntro = document.querySelector(".screen-intro");
    const screenChamber = document.querySelector(".screen-chamber");
    const screenQuiz = document.querySelector(".screen-quiz");
    const screenResult = document.querySelector(".screen-result");
    const screenFeedbackFinal = document.querySelector(".screen-feedback-final");

    document.getElementById("btn-ready").addEventListener("click", () => {
      primeTickAudio();
      screenIntro.classList.add("hidden");
      screenChamber.classList.remove("hidden");
    });

    document.getElementById("btn-start-ritual").addEventListener("click", () => {
      primeTickAudio();
      screenChamber.classList.add("hidden");
      screenQuiz.classList.remove("hidden");
      startRituel();
    });

    const quizIndexEl = document.getElementById("quiz-index");
    const quizTotalEl = document.getElementById("quiz-total");
    const quizQuestionEl = document.getElementById("quiz-question");
    const quizMetaEl = document.getElementById("quiz-meta");
    const quizTimerEl = document.getElementById("quiz-timer");
    const quizExplanationEl = document.getElementById("quiz-explanation");
    const optionButtons = document.querySelectorAll(".quiz-option");
    const btnNext = document.getElementById("btn-next");
    const quizCorrectCountEl = document.getElementById("quiz-correct-count");
    const quizCurrentIndexEl = document.getElementById("quiz-current-index");

    const resultTitleEl = document.getElementById("result-title");
    const resultSubtitleEl = document.getElementById("result-subtitle");
    const resultScoreEl = document.getElementById("result-score");
    const resultTimeEl = document.getElementById("result-time");
    const btnGoFeedback = document.getElementById("btn-go-feedback");

    const feedbackFinalTextEl = document.getElementById("feedback-final-text");
    const feedbackFinalSendBtn = document.getElementById("btn-feedback-final-send");
    const feedbackFinalMessageEl = document.getElementById("feedback-final-message");
    const feedbackFinalSignatureEl = document.getElementById("feedback-final-signature");
    const feedbackFinalCloseBtn = document.getElementById("btn-feedback-close");

    function updateCorrectCounter(){
      quizCorrectCountEl.textContent = String(correctCount);
      quizCurrentIndexEl.textContent = String(currentIndex + 1);
    }

    function startGlobalTimer(){
      if (totalTimer) clearInterval(totalTimer);
      ritualStartTime = Date.now();
      lastTotalSeconds = 0;
      totalTimer = setInterval(() => {
        lastTotalSeconds = Math.round((Date.now() - ritualStartTime) / 1000);
      }, 1000);
    }

    function clearQuestionTimer(){
      if (questionTimer){ clearInterval(questionTimer); questionTimer = null; }
    }

    function clearExplanationCountdown(){
      if (explanationCountdown){ clearInterval(explanationCountdown); explanationCountdown = null; }
    }

    function startQuestionTimer(){
      clearQuestionTimer();
      clearExplanationCountdown();

      const signature = isSignatureIndex(currentIndex);
      const seconds = signature ? 60 : 20;

      questionRemaining = seconds;

      railTotalSeconds = seconds;
      setRailMode("question");
      setRailProgress(questionRemaining, railTotalSeconds);

      setTimerMode("question");
      quizTimerEl.textContent = `Temps ¬∑ ${formatSeconds(questionRemaining)}`;

      questionTimer = setInterval(() => {
        questionRemaining -= 1;
        setRailProgress(questionRemaining, railTotalSeconds);

        if (questionRemaining <= 0){
          questionRemaining = 0;
          quizTimerEl.textContent = `Temps ¬∑ ${formatSeconds(0)}`;
          setRailProgress(0, railTotalSeconds);
          clearQuestionTimer();
          autoValidateOnTimeout();
        } else {
          quizTimerEl.textContent = `Temps ¬∑ ${formatSeconds(questionRemaining)}`;
        }
      }, 1000);
    }

    function startRituel(){
      currentIndex = 0;
      answers = [];
      pendingAnswer = null;
      currentSelection = null;
      showingExplanation = false;
      ritualFinished = false;
      finalPayload = null;

      correctCount = 0;

      clearQuestionTimer();
      clearExplanationCountdown();
      startGlobalTimer();
      renderQuestion();
    }

    function renderQuestion(){
      const q = QUIZ_DATA[currentIndex];

      quizQuestionEl.textContent = q.question || "‚Äî";

      // ‚úÖ Meta affiche domaine + diagnostic non intrusif
      const dom = q.domain || "‚Äî";
      const opts = Array.isArray(q.options) ? q.options : ["","","",""];
      const empty = opts.every(s => !String(s||"").trim() || String(s).trim() === "‚Äî");
      const dbg = ` ¬∑ options:${q._optionsType || typeof q.options}${q._optionsKeys ? `(${q._optionsKeys})` : ""}`;
      quizMetaEl.textContent = `Domaine : ${dom}${empty ? " ¬∑ OPTIONS VIDES" : ""}${dbg}`;

      quizIndexEl.textContent = String(currentIndex + 1);
      quizTotalEl.textContent = String(TOTAL_QUESTIONS);

      setSignatureUI(isSignatureIndex(currentIndex));

      showingExplanation = false;
      quizExplanationEl.classList.add("hidden");
      quizExplanationEl.innerHTML = "";
      pendingAnswer = null;

      clearExplanationCountdown();

      currentShuffle = shuffleArray([0,1,2,3]);

      optionButtons.forEach((btn, displayIndex) => {
        const realIndex = currentShuffle[displayIndex];
        btn.dataset.displayIndex = String(displayIndex);
        btn.dataset.realIndex = String(realIndex);

        // ‚úÖ ICI : on utilise q.options normalis√© (toujours 4 textes)
        const txt = (q.options && q.options[realIndex]) ? String(q.options[realIndex]) : "‚Äî";
        btn.querySelector(".quiz-option-text").textContent = txt;

        btn.classList.remove("selected","disabled","correct","wrong","timeout","shake");
      });

      const wrap = document.getElementById("quiz-options");
      if (wrap) wrap.classList.remove("veil");

      currentSelection = null;
      btnNext.disabled = true;
      btnNext.textContent = (currentIndex === TOTAL_QUESTIONS - 1) ? "Terminer le rituel" : "Valider la r√©ponse";

      updateCorrectCounter();
      startQuestionTimer();
    }

    optionButtons.forEach(btn => {
      btn.addEventListener("click", (e) => {
        primeTickAudio();
        if (showingExplanation) return;
        spawnRipple(btn, e);

        const displayIndex = parseInt(btn.dataset.displayIndex, 10);
        const realIndex = parseInt(btn.dataset.realIndex, 10);

        currentSelection = { displayIndex, actualIndex: realIndex };

        optionButtons.forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
        btnNext.disabled = false;
      });
    });

    function advanceFromExplanation(){
      if (!showingExplanation) return;

      showingExplanation = false;
      clearExplanationCountdown();
      setTimerMode("question");

      if (pendingAnswer){
        answers.push(pendingAnswer);
        pendingAnswer = null;
      }

      if (currentIndex < TOTAL_QUESTIONS - 1){
        currentIndex += 1;
        renderQuestion();
      } else {
        endRituel();
      }

      updateCorrectCounter();
    }

    function resolveCurrentQuestion(forceTimeout=false){
      if (showingExplanation) return;

      clearQuestionTimer();
      clearExplanationCountdown();

      const q = QUIZ_DATA[currentIndex];

      let choiceIndex, choiceLetter, userText;
      let isTimeout = false;

      if (!currentSelection || forceTimeout){
        choiceIndex = -1;
        choiceLetter = "-";
        userText = "Aucune r√©ponse (temps √©coul√©)";
        isTimeout = true;
      } else {
        choiceIndex = currentSelection.actualIndex;
        choiceLetter = LETTERS[currentSelection.displayIndex];
        userText = q.options[choiceIndex] || "‚Äî";
      }

      const correctIndex = Number(q.correct_index) || 0;
      const correctDisplayIndex = currentShuffle.indexOf(correctIndex);
      const correctLetter = LETTERS[correctDisplayIndex >= 0 ? correctDisplayIndex : 0];
      const correctText = q.options[correctIndex] || "‚Äî";

      const isCorrect = !isTimeout && (choiceIndex === correctIndex);

      if (isCorrect) correctCount += 1;
      updateCorrectCounter();

      let resultLabel = "";
      let resultClass = "";
      if (isTimeout){ resultLabel = "Temps √©coul√©"; resultClass = "timeout"; }
      else if (isCorrect){ resultLabel = "Bonne r√©ponse"; resultClass = "good"; }
      else { resultLabel = "Mauvaise r√©ponse"; resultClass = "bad"; }

      const explanationText = (q.explication || "").trim();

      quizExplanationEl.innerHTML = `
        <div class="quiz-explanation-line ex-user">
          <span class="ex-label">Ta r√©ponse</span>
          <span class="letter">${choiceLetter}</span>
          <span class="text"> ‚Äî ${userText}</span>
        </div>
        <div class="quiz-explanation-line ex-result ${resultClass}">
          ${resultLabel}
        </div>
        <div class="quiz-explanation-line ex-correct">
          <span class="ex-label">R√©ponse attendue</span>
          <span class="letter">${correctLetter}</span>
          <span class="text"> ‚Äî ${correctText}</span>
        </div>
        ${explanationText ? `<div class="quiz-explanation-line ex-orion">${explanationText}</div>` : ""}
      `;
      quizExplanationEl.classList.remove("hidden");

      optionButtons.forEach(b => b.classList.add("disabled"));
      showingExplanation = true;

      optionButtons.forEach(b => b.classList.remove("correct","wrong","timeout","shake"));

      const selectedDisplay = currentSelection ? currentSelection.displayIndex : null;

      performVerdictReveal((correctDisplayIndex >= 0 ? correctDisplayIndex : 0), () => {
        if (isTimeout){
          const correctBtn = optionButtons[correctDisplayIndex >= 0 ? correctDisplayIndex : 0];
          if (correctBtn) correctBtn.classList.add("correct");
          optionButtons.forEach(b => b.classList.add("timeout"));
        } else {
          const selectedBtn = (selectedDisplay !== null) ? optionButtons[selectedDisplay] : null;
          const correctBtn = optionButtons[correctDisplayIndex >= 0 ? correctDisplayIndex : 0];

          if (isCorrect){
            if (selectedBtn) selectedBtn.classList.add("correct");
          } else {
            if (selectedBtn){
              selectedBtn.classList.add("wrong","shake");
              setTimeout(() => selectedBtn.classList.remove("shake"), 220);
            }
            if (correctBtn) correctBtn.classList.add("correct");
          }
        }
      });

      btnNext.textContent = (currentIndex === TOTAL_QUESTIONS - 1) ? "Terminer le rituel" : "Question suivante";
      pendingAnswer = { question_id: q.id, choice_index: choiceIndex, choice_letter: choiceLetter };
      btnNext.disabled = false;

      const signature = isSignatureIndex(currentIndex);
      explanationRemaining = signature ? 60 : 45;

      railTotalSeconds = explanationRemaining;
      setRailMode("lecture");
      setRailProgress(explanationRemaining, railTotalSeconds);

      setTimerMode("lecture");
      quizTimerEl.textContent = `Lecture ¬∑ ${formatSeconds(explanationRemaining)}`;

      clearExplanationCountdown();
      explanationCountdown = setInterval(() => {
        explanationRemaining -= 1;
        setRailProgress(explanationRemaining, railTotalSeconds);

        if (explanationRemaining <= 0){
          explanationRemaining = 0;
          quizTimerEl.textContent = `Lecture ¬∑ ${formatSeconds(0)}`;
          setRailProgress(0, railTotalSeconds);
          clearExplanationCountdown();
          if (showingExplanation && !ritualFinished) advanceFromExplanation();
        } else {
          quizTimerEl.textContent = `Lecture ¬∑ ${formatSeconds(explanationRemaining)}`;
        }
      }, 1000);
    }

    function autoValidateOnTimeout(){
      if (!showingExplanation){
        if (currentSelection) resolveCurrentQuestion(false);
        else resolveCurrentQuestion(true);
      }
    }

    btnNext.addEventListener("click", () => {
      primeTickAudio();
      if (!showingExplanation){
        if (!currentSelection) return;
        resolveCurrentQuestion(false);
        return;
      }
      advanceFromExplanation();
    });

    function endRituel(){
      if (totalTimer){ clearInterval(totalTimer); totalTimer = null; }
      clearQuestionTimer();
      clearExplanationCountdown();

      finalTotalSeconds = lastTotalSeconds;

      finalScore = 0;
      finalEnrichedAnswers = answers.map(a => {
        const q = QUIZ_DATA.find(qq => qq.id === a.question_id);
        let status = "wrong";

        if (a.choice_index === -1) status = "timeout";
        else if (q && a.choice_index === q.correct_index){ status = "correct"; finalScore += 1; }

        return { question_id: a.question_id, choice_letter: a.choice_letter, status };
      });

      ritualFinished = true;

      let verdictTitle, verdictSubtitle;
      if (finalScore >= 12){
        verdictTitle = "Admission potentielle";
        verdictSubtitle = "Ton niveau rejoint un cercle restreint. Le reste se joue dans la dur√©e.";
      } else {
        verdictTitle = "Rituel non valid√©";
        verdictSubtitle = "Ce n‚Äôest pas une fin, seulement un instantan√© de ton niveau aujourd‚Äôhui.";
      }

      resultTitleEl.textContent = verdictTitle;
      resultSubtitleEl.textContent = verdictSubtitle;
      resultScoreEl.textContent = `${finalScore} / ${TOTAL_QUESTIONS}`;
      resultTimeEl.textContent = formatSeconds(finalTotalSeconds);

      screenQuiz.classList.add("hidden");
      screenResult.classList.remove("hidden");
    }

    btnGoFeedback.addEventListener("click", () => {
      primeTickAudio();
      screenResult.classList.add("hidden");
      screenFeedbackFinal.classList.remove("hidden");
    });

    feedbackFinalSendBtn.disabled = true;
    feedbackFinalTextEl.addEventListener("input", () => {
      feedbackFinalSendBtn.disabled = (feedbackFinalTextEl.value.trim().length === 0);
    });

    feedbackFinalSendBtn.addEventListener("click", () => {
      primeTickAudio();
      if (feedbackFinalSendBtn.disabled) return;

      const feedbackText = feedbackFinalTextEl.value.trim();

      finalPayload = {
        mode: "rituel_full_v1",
        score: finalScore,
        total: TOTAL_QUESTIONS,
        time_spent_seconds: finalTotalSeconds,
        time_total_seconds: finalTotalSeconds,
        time_formatted: formatSeconds(finalTotalSeconds),
        answers: finalEnrichedAnswers,
        feedback_text: feedbackText,
        analysis_mode: "nova_writing_score_v1"
      };

      feedbackFinalSendBtn.disabled = true;
      feedbackFinalTextEl.readOnly = true;
      feedbackFinalSendBtn.classList.add("hidden");

      feedbackFinalMessageEl.classList.remove("hidden");
      feedbackFinalMessageEl.innerHTML = `
        Merci. Ton passage est inscrit.<br><br>
        Certains rituels ferment un cycle. Celui-ci en ouvre un autre ‚Äî plus discret, plus exigeant.<br><br>
        Si un jour ton nom doit revenir dans nos cercles, ce sera naturellement.
      `;
      feedbackFinalSignatureEl.classList.remove("hidden");
      feedbackFinalCloseBtn.classList.remove("hidden");
    });

    feedbackFinalCloseBtn.addEventListener("click", () => {
      primeTickAudio();
      if (!finalPayload) return;
      if (tg && typeof tg.sendData === "function") tg.sendData(JSON.stringify(finalPayload));
      else console.log("Envoi simul√© rituel_full_v1:", finalPayload);
    });
  </script>
</body>
</html>
