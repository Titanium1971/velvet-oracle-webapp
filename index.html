<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Velvet Oracle — Examen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #050507;
      color: #f5f5f5;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }
    .app {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 16px;
      box-sizing: border-box;
    }
    .screen {
      display: none;
      flex: 1;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }
    .screen.active {
      display: flex;
    }
    h1, h2, h3 {
      margin: 0 0 12px;
      font-weight: 600;
    }
    p {
      margin: 0 0 12px;
      line-height: 1.5;
      color: #d2d2d2;
    }
    .btn {
      display: inline-block;
      padding: 12px 20px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #b38b45, #e2c27a);
      color: #050507;
      font-weight: 600;
      cursor: pointer;
      margin-top: 16px;
      font-size: 15px;
    }
    .btn:disabled {
      opacity: 0.4;
      cursor: default;
    }
    .question-card {
      width: 100%;
      max-width: 480px;
      background: #0c0c10;
      border-radius: 16px;
      padding: 16px;
      box-sizing: border-box;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.04);
      text-align: left;
    }
    .chips-row {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin-bottom: 8px;
      color: #aaa;
    }
    .question-text {
      font-size: 16px;
      margin-bottom: 16px;
    }
    .options {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
    }
    .option {
      border-radius: 999px;
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,0.12);
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .option-label {
      opacity: 0.7;
      margin-right: 8px;
    }
    .option-text {
      flex: 1;
    }
    .option.selected {
      border-color: #e2c27a;
      background: rgba(226,194,122,0.09);
    }
    .option.disabled {
      opacity: 0.4;
      cursor: default;
    }
    .timer-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: #aaa;
      margin-bottom: 8px;
    }
    .timer-value {
      font-variant-numeric: tabular-nums;
      font-weight: 600;
    }
    .explanation {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed rgba(255,255,255,0.14);
      font-size: 13px;
      color: #c7c7c7;
    }
    .explanation strong {
      color: #e2c27a;
    }
    textarea {
      width: 100%;
      max-width: 480px;
      min-height: 120px;
      background: #0c0c10;
      color: #f5f5f5;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      padding: 10px;
      box-sizing: border-box;
      resize: vertical;
      font-size: 14px;
    }
    .footer {
      margin-top: 24px;
      font-size: 11px;
      color: #777;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Intro -->
    <div id="screen-intro" class="screen active">
      <div>
        <h1>Velvet Oracle</h1>
        <p>
          Tu t’apprêtes à passer un examen conçu pour mesurer autant ta culture
          que ta manière de te tenir dans l’incertitude.
        </p>
        <p>
          15 questions, 20 secondes chacune, un seul passage officiel.
        </p>
        <button class="btn" id="btn-intro">Entrer dans la chambre d’examen</button>
      </div>
    </div>

    <!-- Questions -->
    <div id="screen-quiz" class="screen">
      <div class="question-card">
        <div class="chips-row">
          <span id="chip-progress">Question 1 / 15</span>
          <span id="chip-domain">Domaine</span>
        </div>
        <div class="timer-row">
          <span>Temps</span>
          <span id="timer-value" class="timer-value">00:20</span>
        </div>
        <div id="question-text" class="question-text">
          Question en cours…
        </div>
        <div id="options-container" class="options"></div>
        <button class="btn" id="btn-next">Valider</button>
        <div id="explanation-block" class="explanation" style="display:none;"></div>
      </div>
    </div>

    <!-- Résultats + feedback -->
    <div id="screen-result" class="screen">
      <div>
        <h2>Rituel complété</h2>
        <p id="result-summary"></p>
        <p>
          Tu peux, si tu le souhaites, nous laisser un court ressenti.
          Ce texte rejoindra discrètement ton dossier.
        </p>
        <textarea id="feedback-input" placeholder="Écris ici, en toute franchise…"></textarea>
        <button class="btn" id="btn-send-feedback">Envoyer & fermer</button>
        <div class="footer">
          Velvet Oracle — Examen graphique · Première édition
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================================================
    // Intégration Telegram
    // =========================================================
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if (tg) {
      tg.ready();
      tg.expand();
      tg.setBackgroundColor("#050507");
      tg.setHeaderColor("#050507");
    }

    // =========================================================
    // Données d'examen (placeholder local)
    // =========================================================
    const QUESTIONS = [
      {
        id: 1,
        domain: "Musique",
        question: "Dans l’effervescence baroque italienne, quel maître fixe vraiment la grammaire du concerto moderne ?",
        options: [
          "Antonio Vivaldi",      // correct
          "Arcangelo Corelli",
          "Giuseppe Torelli",
          "Tomaso Albinoni",
        ],
        correct_index: 0,
        explanation: "Vivaldi fixe les codes du concerto (3 mouvements, soliste/orchestre) de manière définitive."
      },
      {
        id: 2,
        domain: "Civilisations",
        question: "Parmi ces cités antiques, laquelle symbolise le mieux l’idéal de la cité-État démocratique en Méditerranée ?",
        options: [
          "Athènes",     // correct
          "Sparte",
          "Carthage",
          "Babylone",
        ],
        correct_index: 0,
        explanation: "Athènes devient la référence historique pour les expériences démocratiques anciennes."
      },
      // ... jusqu'à 15 questions (placeholder)
    ];

    const TOTAL_QUESTIONS = QUESTIONS.length;
    const TIME_PER_QUESTION = 20; // secondes

    // =========================================================
    // État
    // =========================================================
    let currentIndex = 0;
    let currentShuffle = [];
    let currentSelection = null; // index dans currentShuffle
    let answersLog = []; // {question_id, choice_index, choice_letter, status}
    let showingExplanation = false;

    let questionTimer = null;
    let questionRemaining = TIME_PER_QUESTION;

    let examStartTs = null;
    let examEndTs = null;

    // =========================================================
    // Utilitaires
    // =========================================================
    function $(id) {
      return document.getElementById(id);
    }

    function showScreen(id) {
      document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
      $(id).classList.add("active");
    }

    function formatSeconds(sec) {
      const s = Math.max(0, Math.floor(sec));
      const m = Math.floor(s / 60);
      const r = s % 60;
      return `${String(m).padStart(2,"0")}:${String(r).padStart(2,"0")}`;
    }

    function shuffleIndices(n) {
      const arr = Array.from({length: n}, (_, i) => i);
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function letterFromIndex(idx) {
      return ["A","B","C","D"][idx] || "-";
    }

    function clearQuestionTimer() {
      if (questionTimer !== null) {
        clearInterval(questionTimer);
        questionTimer = null;
      }
    }

    // =========================================================
    // Rendu des questions
    // =========================================================
    function renderQuestion() {
      showingExplanation = false;
      currentSelection = null;
      clearQuestionTimer();

      const q = QUESTIONS[currentIndex];
      const shuffle = shuffleIndices(q.options.length);
      currentShuffle = shuffle;

      $("chip-progress").textContent = `Question ${currentIndex + 1} / ${TOTAL_QUESTIONS}`;
      $("chip-domain").textContent = q.domain || "Velvet";
      $("question-text").textContent = q.question;

      const optionsContainer = $("options-container");
      optionsContainer.innerHTML = "";

      shuffle.forEach((origIdx, pos) => {
        const opt = document.createElement("div");
        opt.className = "option";
        opt.dataset.pos = String(pos);

        const label = document.createElement("span");
        label.className = "option-label";
        label.textContent = letterFromIndex(pos);

        const text = document.createElement("span");
        text.className = "option-text";
        text.textContent = q.options[origIdx];

        opt.appendChild(label);
        opt.appendChild(text);

        opt.addEventListener("click", () => {
          if (showingExplanation) return;
          selectOption(pos);
        });

        optionsContainer.appendChild(opt);
      });

      $("explanation-block").style.display = "none";
      $("explanation-block").innerHTML = "";
      $("btn-next").textContent = "Valider";
      $("btn-next").disabled = false;

      questionRemaining = TIME_PER_QUESTION;
      $("timer-value").textContent = formatSeconds(questionRemaining);

      questionTimer = setInterval(() => {
        questionRemaining -= 1;
        if (questionRemaining <= 0) {
          questionRemaining = 0;
          $("timer-value").textContent = formatSeconds(questionRemaining);
          clearQuestionTimer();
          // auto validation (timeout)
          resolveQuestion(true);
        } else {
          $("timer-value").textContent = formatSeconds(questionRemaining);
        }
      }, 1000);
    }

    function selectOption(pos) {
      currentSelection = pos;
      document.querySelectorAll(".option").forEach(opt => {
        opt.classList.toggle("selected", opt.dataset.pos === String(pos));
      });
    }

    function resolveQuestion(fromTimeout) {
      if (showingExplanation) return;
      showingExplanation = true;
      clearQuestionTimer();

      const q = QUESTIONS[currentIndex];
      const correctIndex = q.correct_index;
      const shuffle = currentShuffle;

      let status = "wrong";
      let choicePos = currentSelection;
      let choiceLetter = "-";

      if (fromTimeout && choicePos === null) {
        status = "timeout";
      } else {
        if (choicePos === null) {
          // pas cliqué mais timer pas à zéro -> considère timeout
          status = "timeout";
        } else {
          const origIdx = shuffle[choicePos];
          if (origIdx === correctIndex) {
            status = "correct";
          } else {
            status = "wrong";
          }
          choiceLetter = letterFromIndex(choicePos);
        }
      }

      // désactive les options
      document.querySelectorAll(".option").forEach(opt => {
        opt.classList.add("disabled");
      });

      // log interne
      answersLog.push({
        question_id: q.id,
        choice_index: choicePos !== null ? choicePos : -1,
        choice_letter: choiceLetter,
        status: status,
      });

      // explication
      const explBlock = $("explanation-block");
      explBlock.style.display = "block";
      let verdictText = "";
      if (status === "correct") {
        verdictText = "Bonne réponse.";
      } else if (status === "wrong") {
        verdictText = "Mauvaise réponse.";
      } else {
        verdictText = "Temps écoulé — aucune réponse enregistrée.";
      }

      const correctLetterPos = shuffle.indexOf(correctIndex);
      const correctLetter = letterFromIndex(correctLetterPos);

      explBlock.innerHTML = `
        <strong>${verdictText}</strong><br/>
        Réponse attendue : <strong>${correctLetter}</strong> — ${q.options[correctIndex]}<br/><br/>
        <em>${q.explanation || ""}</em>
      `;

      $("btn-next").textContent =
        currentIndex === TOTAL_QUESTIONS - 1 ? "Terminer l’examen" : "Question suivante";
    }

    function handleNextClick() {
      if (!showingExplanation) {
        // validation manuelle
        resolveQuestion(false);
        return;
      }
      // passer à la question suivante ou terminer
      if (currentIndex < TOTAL_QUESTIONS - 1) {
        currentIndex += 1;
        renderQuestion();
      } else {
        endExam();
      }
    }

    // =========================================================
    // Fin d'examen & envoi au bot
    // =========================================================
    function endExam() {
      examEndTs = Date.now();

      const score = answersLog.filter(a => a.status === "correct").length;
      const total = TOTAL_QUESTIONS;
      const totalSeconds =
        examStartTs && examEndTs
          ? Math.round((examEndTs - examStartTs) / 1000)
          : 0;

      const enrichedAnswers = answersLog.map(a => ({
        question_id: a.question_id,
        choice_letter: a.choice_letter,
        status: a.status,
      }));

      const payloadExam = {
        mode: "exam_v1",
        score: score,
        total: total,
        total_time_seconds: totalSeconds,
        answers: enrichedAnswers,
      };

      if (tg && tg.sendData) {
        tg.sendData(JSON.stringify(payloadExam));
      } else {
        console.log("Exam payload:", payloadExam);
      }

      // affichage local
      $("result-summary").textContent =
        `Score : ${score}/${total} · Temps total : ${formatSeconds(totalSeconds)}.`;

      // stocker pour feedback
      window.__velvetExamMeta = {
        score: score,
        total: total,
        total_time_seconds: totalSeconds,
      };

      showScreen("screen-result");
    }

    function sendFeedback() {
      const fb = ($("feedback-input").value || "").trim();
      const meta = window.__velvetExamMeta || {
        score: 0,
        total: TOTAL_QUESTIONS,
        total_time_seconds: 0,
      };

      const payloadFeedback = {
        mode: "exam_feedback_v1",
        feedback_text: fb,
        score: meta.score,
        total: meta.total,
        total_time_seconds: meta.total_time_seconds,
        analysis_mode: "nova_writing_score_v1",
      };

      if (tg && tg.sendData) {
        tg.sendData(JSON.stringify(payloadFeedback));
      } else {
        console.log("Feedback payload:", payloadFeedback);
      }

      $("btn-send-feedback").disabled = true;
      $("btn-send-feedback").textContent = "Reçu";
      $("feedback-input").readOnly = true;

      if (tg && tg.close) {
        setTimeout(() => tg.close(), 800);
      }
    }

    // =========================================================
    // Écouteurs
    // =========================================================
    $("btn-intro").addEventListener("click", () => {
      examStartTs = Date.now();
      currentIndex = 0;
      answersLog = [];
      showScreen("screen-quiz");
      renderQuestion();
    });

    $("btn-next").addEventListener("click", handleNextClick);
    $("btn-send-feedback").addEventListener("click", sendFeedback);
  </script>
</body>
</html>
